<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
<title>[DS] Presentation Mechanisms</title>
<meta name="description" content="Presentation Mechanisms for Distributed Systems">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="/slides-module2.github.io/reveal-js/dist/reset.css">
<link rel="stylesheet" href="/slides-module2.github.io/reveal-js/dist/reveal.css">
  <link rel="stylesheet" href="/slides-module2.github.io/css/custom-theme.min.e415e19db372f1135499fc2ea3a836cea3f048a00982e05f2d60d127261af094.css" id="theme"><link rel="stylesheet" href="/slides-module2.github.io/highlight-js/solarized-dark.min.css">
<link href="https://fonts.googleapis.com/css?family=Roboto Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Oxygen Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Ubuntu Mono" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/gh/DanySK/css-blur-animation/blur.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://kit.fontawesome.com/81ac037be0.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
<script src="https://unibo-fc-isi-ds/slides-module2.github.io//plantuml.js"></script>

  </head>
  <body>
    
    <div class="reveal">
      <div class="slides">
  

    <section><h1 id="presentation-mechanisms-for-distributed-systems">Presentation Mechanisms for Distributed Systems</h1>
<br>
<h2 id="hahahugoshortcode1s0hbhb">Distributes Systems — Module 2</h2>
<h3 id="hahahugoshortcode1s1hbhb">A.Y. 2024/2025</h3>
<h3 id="hahahugoshortcode1s2hbhb"><a href="mailto:giovanni.ciatto@unibo.it">Giovanni Ciatto</a></h3>
<br>
<br>
<p>Compiled on: 2024-10-26
 — <a href="?print-pdf&amp;pdfSeparateFragments=false"><i class="fa fa-print" aria-hidden="true"></i> printable version</a></p>
<p><a href="../#/toc"><i class="fa fa-undo" aria-hidden="true"></i> back to ToC</a></p>
</section><section>
<h2 id="context">Context</h2>
<ul>
<li>
<p>Nodes in distributed systems may be implemented in <em>different languages</em> (e.g. C, Java, Python, etc.)</p>
<ul>
<li>possibly running on <em>different platforms</em> (e.g. Python, JVM, Node, etc.) and <em>OS</em> (e.g. Windows, Linux, etc.)</li>
<li>possibly using <em>different data representations conventions</em> (e.g. big-endian, little-endian, etc.)</li>
</ul>
</li>
<li>
<p>As long as nodes comply to the <strong>same</strong> <em>communication protocols</em> and <em>patterns</em>, technological issues should <em>not</em> be a problem</p>
<ul>
<li><strong>presentation</strong> mechanisms are responsible for <em>representing</em> data in a <strong>common format</strong>
<ul>
<li>in order to <em>exchange</em> information smoothly between <em>heterogeneous</em> nodes</li>
</ul>
</li>
</ul>
</li>
<li>
<p>So far all examples have been in <em>Python</em> (for simplicity)…</p>
<ul>
<li>so, in practice, the “common format” didn’t need to be <em>explicitly</em> defined</li>
</ul>
</li>
<li>
<p>… but, in the <em>real world</em>, we need to <em>serialize</em> and <em>deserialize</em> data explicitly into/from a <em>common format</em></p>
<ul>
<li>this is the role of <strong>data interchange formats</strong>, such as:
<ul>
<li><a href="https://en.wikipedia.org/wiki/JSON">JavaScript Object Notation (JSON)</a> (<em>we will use this one</em>)</li>
<li><a href="https://en.wikipedia.org/wiki/YAML">Yet Another Markup Language (YAML)</a> (later renamed in “YAML Ain’t Markup Language”)</li>
<li><a href="https://en.wikipedia.org/wiki/XML">eXtensible Markup Language (XML)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Type-length-value">Type–length–value (TLV)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Protocol_Buffers">Protocol Buffers</a></li>
<li><a href="https://avro.apache.org/">Avro</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="content-of-the-lecture">Content of the lecture</h2>
<p>A lot of concepts to unpack here:</p>
<ol>
<li>
<p><strong>(De)Serialization</strong>: this is the <em>main goal</em> of this lecture</p>
<ul>
<li><em>serialization</em> is the process of converting an object into a stream of characters/bytes</li>
<li><em>deserialization</em> is the reverse process</li>
<li>both operations imply a <em>common</em> target/source <strong>data interchange format</strong> (e.g. JSON)</li>
<li>both operations are _<strong>unavoidable</strong> in distributed systems programming</li>
</ul>
</li>
<li>
<p><strong>Remote Procedure Call</strong> (RPC): this is a very common <em>interaction pattern</em> in distributed systems</p>
<ul>
<li>it allows a client program to <em>invoke</em> a procedure from a remote server</li>
<li>it implies <strong>(de)serializing</strong> <em>parameters</em> and <em>results</em> of the procedure</li>
<li>so it’s the perfect <em>example</em> to illustrate how (de)serialization is used <em>in practice</em></li>
</ul>
</li>
<li>
<p><strong>Authentication</strong>: this is another <em>common</em> concern in distributed systems</p>
<ul>
<li>it implies clients providing <em>credentials</em> to servers to <em>prove</em> their identity</li>
<li>it is commonly <em>implemented</em> by means of <em>RPC</em>…</li>
<li>… so it’s a good <em>example</em> to illustrate how RPC is used <em>in practice</em></li>
<li>this is <em>not</em> strictly related to (de)serialization, but it’s a <em>good</em> example of <em>RPC</em>, and it <em>exploits</em> (de)serialization a lot</li>
</ul>
</li>
</ol>
</section><section>


<section data-shortcode-section="">
<h1 id="information-representation-101">Information Representation 101</h1>
<h2 id="quick-and-practical-excursus">(quick and practical excursus)</h2>
</section><section>
<h2 id="information-representation-recap-pt-1">Information Representation Recap (pt. 1)</h2>
<ul>
<li>
<p>In electronic systems, information is represented as <em>binary data</em></p>
<ul>
<li>i.e. sequences of <em>0s</em> and <em>1s</em></li>
</ul>
</li>
<li>
<p>For many practical reasons, binary sequences are commonly grouped in <em>bytes</em></p>
<ul>
<li><em>byte</em> $\equiv$ <em>8 bits</em> $\equiv$ <em>2 hexadecimal digits</em></li>
<li>e.g. <code>0x00</code>$\equiv$ 0, <code>0x01</code> $\equiv$ 1, <code>0x02</code> $\equiv$ 2, …, <code>0xFF</code> $\equiv$ 255</li>
</ul>
</li>
<li>
<p>Sequences of <em>bytes</em> can be used to represent many <em>sorts</em> of data, via ad-hoc <strong>conventions</strong></p>
<ul>
<li>e.g. <em>ASCII</em> (for text): e.g. <code>0x41</code> $\equiv$ 45 $\equiv$ <code>A</code>  (cf. <a href="https://www.asciitable.com/">ASCII Table</a>)</li>
<li>e.g. <em>UTF-8</em> (for text): e.g. <code>0xC3A0</code> $\equiv$ 50080 $\equiv$ <code>à</code> (cf. <a href="https://www.utf8-chartable.de/">UTF-8 Table</a>)</li>
<li>e.g. <em>little-endian</em> (for 32-bit integers): e.g. <code>0x3000</code> $\equiv$ 3 (cf. <a href="https://en.wikipedia.org/wiki/Endianness">Endianness</a>)</li>
<li>e.g. <em>big-endian</em> (for 32-bit integers): e.g. <code>0x0003</code> $\equiv$ 3 (cf. <a href="https://en.wikipedia.org/wiki/Endianness">Endianness</a>)</li>
</ul>
</li>
<li>
<p>Conventions $\approx$ data interchange formats</p>
<ul>
<li>they define how <em>data</em> is <em>encoded</em> into <em>bytes</em></li>
<li>they define how <em>bytes</em> should be <em>decoded</em> into <em>data</em></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>The problem</strong>: most programming languages / platforms / OS use <em>different</em> conventions for representing data
<br> <strong>The solution</strong>: <em>agree</em> on the data format to use for <em>communication</em></p>
</blockquote>
<p>corollary: data interchange formats are an <strong>essential</strong> aspect of every interaction pattern / protocol</p>
</section><section>
<h2 id="two-broad-categories-of-data-interchange-formats">Two broad categories of data interchange formats</h2>
<ol>
<li>
<p><strong>Text-based</strong> formats: they rely on <em>characters</em> to represent data (<em>we will use these ones</em>)</p>
<ul>
<li>e.g. <em>JSON</em>, <em>YAML</em>, <em>XML</em></li>
<li><strong>human-readable</strong>, <em>easy to debug</em>, <em>easy to parse</em>, possibility to <em>manually</em> edit the data</li>
<li><em>verbose</em>, <em>inefficient</em> (in terms of space)</li>
<li>may require tricks to represent <em>binary</em> data (e.g. <em>escape sequences</em>, or <em>base64</em> encoding)</li>
</ul>
</li>
<li>
<p><strong>Binary</strong> formats: they rely on <em>bytes</em> to represent data</p>
<ul>
<li>e.g. <em>Protocol Buffers</em>, <em>Avro</em></li>
<li><em>compact</em>, <em>efficient</em> (in terms of space)</li>
<li><em>harder</em> to debug, <em>harder</em> to parse, <em>harder</em> to manually edit the data (commonly require <em>hex editors</em>)</li>
<li><em>natively</em> support <em>binary</em> data, but can represent <em>text</em> as well</li>
</ul>
</li>
</ol>
<blockquote>
<p>But aren’t <em>characters</em> just <em>bytes</em>? Why do we need <em>different</em> formats for <em>text</em> and <em>binary</em> data?</p>
</blockquote>
<ul>
<li>In practice, engineers may prioritize human-readability if saving space is not a concern
<ul>
<li>e.g. on the Web</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="characters-vs-bytes-encoding">Characters vs Bytes: Encoding</h2>
<ul>
<li>
<p>Characters are <strong>equivalent</strong> to bytes, according to an <strong>encoding</strong> scheme</p>
<ul>
<li>e.g. <em>ASCII</em>, <em>UTF-8</em>, <em>UTF-16</em>, <em>ISO-8859-1</em>, etc.</li>
</ul>
</li>
<li>
<p><em>ASCII</em> is the <em>oldest</em> encoding scheme, where each character is represented by a <em>single</em> byte (but only 7 bits are used)</p>
<ul>
<li>e.g. <code>A</code> $\equiv$ <code>0x41</code>, <code>B</code> $\equiv$ <code>0x42</code>, …, <code>a</code> $\equiv$ <code>0x61</code>, <code>b</code> $\equiv$ <code>0x62</code>, …
(this is what strings are represented in <em>C</em> and <em>Python 2</em>)</li>
</ul>
</li>
<li>
<p><em>Unicode</em>: an abstract way to represent information, coming with three different encoding schemes:</p>
<ul>
<li>
<p><em>UTF-8</em> is the <em>most common</em> encoding scheme, where each character is represented by <em>1 to 4</em> bytes</p>
<ul>
<li>e.g. <code>A</code> $\equiv$ <code>0x41</code>, <code>B</code> $\equiv$ <code>0x42</code>, …, <code>à</code> $\equiv$ <code>0xC3A0</code>, <code>è</code> $\equiv$ <code>0xC3A8</code>, …
(this is what strings are represented in <em>Python 3</em>, and most modern programming languages)</li>
</ul>
</li>
<li>
<p><em>UTF-16</em> is another common encoding scheme, where each character is represented by <em>2 or 4</em> bytes</p>
<ul>
<li>e.g. <code>A</code> $\equiv$ <code>0x0041</code>, <code>B</code> $\equiv$ <code>0x0042</code>, …, <code>à</code> $\equiv$ <code>0x00E0</code>, <code>è</code> $\equiv$ <code>0x00E8</code>, …</li>
</ul>
</li>
<li>
<p><em>UTF-32</em> is another encoding scheme, where each character is represented by <em>4</em> bytes</p>
<ul>
<li>e.g. <code>A</code> $\equiv$ <code>0x00000041</code>, <code>B</code> $\equiv$ <code>0x00000042</code>, …, <code>à</code> $\equiv$ <code>0x000000E0</code>, <code>è</code> $\equiv$ <code>0x000000E8</code>, …</li>
</ul>
</li>
</ul>
</li>
<li>
<p><em>ISO-8859-1</em> is another encoding scheme, where each character is represented by a <em>single</em> byte</p>
<ul>
<li>e.g. <code>A</code> $\equiv$ <code>0x41</code>, <code>B</code> $\equiv$ <code>0x42</code>, …, <code>à</code> $\equiv$ <code>0xE0</code>, <code>è</code> $\equiv$ <code>0xE8</code>, …</li>
</ul>
</li>
</ul>
<blockquote>
<p><em>Notice</em> that most of these encoding schemes are <em>compatible</em> with <em>ASCII</em> (i.e. the first 128 characters are the same)
this is why inexperienced programmers <em>often</em> don’t <em>notice</em> the difference between encodings</p>
</blockquote>
</section><section>
<h2 id="encoding-in-python">Encoding in Python</h2>
<ul>
<li>
<p>Python comes with the following <em>built-in</em> types to represent sequences of characters and bytes:</p>
<ul>
<li><code>str</code> for <em>textual</em> data (uses <em>UTF-8</em> encoding in Python 3, <em>ASCII</em> in Python 2), literals are of the from <code>"..."</code> or <code>'''...'''</code></li>
<li><code>bytes</code>for <em>binary</em> data (similar to byte arrays in other languages), literals are of the form <code>b"..."</code> or <code>b'...'</code></li>
</ul>
</li>
<li>
<p>Python also comes with functions to convert between <em>bytes</em> and <em>strings</em>:</p>
<ul>
<li><code>str.encode(ENCODING)</code>: converts a string into a sequence of bytes using the specified <code>ENCODING</code></li>
<li><code>bytes.decode(ENCODING)</code>: converts a sequence of bytes into a string <code>ENCODING</code></li>
<li>in both cases, <code>ENCODING</code> is a string representing the encoding scheme to use (e.g. <code>"utf-8"</code>, <code>"ascii"</code>, etc.)</li>
<li>if not specified, the default encoding is used (e.g. <code>import sys; sys.getdefaultencoding()</code>)</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">"À l'école, l'élève étudiait l'histoire de la Révolution française et les événements marquants de l'été 1789."</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'utf-8'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># b"\xc3\x80 l'\xc3\xa9cole, l'\xc3\xa9l\xc3\xa8ve \xc3\xa9tudiait l'histoire de la R\xc3\xa9volution fran\xc3\xa7aise et les \xc3\xa9v\xc3\xa9nements marquants de l'\xc3\xa9t\xc3\xa9 1789."</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'utf-8'</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># "À l'école, l'élève étudiait l'histoire de la Révolution française et les événements marquants de l'été 1789."</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'ascii'</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># UnicodeDecodeError: 'ascii' codec can't decode byte 0xc3 in position 0: ordinal not in range(128)</span>
</span></span></code></pre></div></section><section>
<h2 id="escape-sequences">Escape sequences</h2>
<ul>
<li>
<p>When using textual encodings, there maybe situations where some characters <em>cannot</em> be <em>directly</em> represented/inserted in a string</p>
<ul>
<li>e.g. <em>control characters</em> (e.g. <code>\n</code>, <code>\t</code>, <code>\r</code>, etc.)</li>
<li>e.g. <em>non-printable characters</em> (e.g. <code>0x00</code>, <code>0x01</code>, etc.)</li>
</ul>
</li>
<li>
<p>Other than supporting encodings, most <em>programming</em> or <em>data representation languages</em> also support_</p>
<ul>
<li><strong>escape sequences</strong> $\approx$ sub-sequences of characters that represent a <em>single</em> character</li>
</ul>
</li>
<li>
<p>Most commonly:</p>
<ul>
<li>there is an <em>escape character</em> (commonly <code>\</code>) that <em>initiates</em> the escape sequence</li>
<li>what can follow the escape character is <em>technology-dependent</em>, but most languages support the following:
<ul>
<li><code>\n</code> $\equiv$ newline</li>
<li><code>\t</code> $\equiv$ tab</li>
<li><code>\r</code> $\equiv$ carriage return</li>
<li><code>\\</code> $\equiv$ backslash (the single <code>\</code> is the escape character, so you need <code>\\</code> to represent a single <code>\</code>)</li>
<li><code>\"</code> $\equiv$ double quote</li>
<li><code>\'</code> $\equiv$ single quote</li>
<li><code>\xHH</code> (or <code>\uHHHH</code>, or <code>\UHHHHHHHH</code>) $\equiv$ byte with hexadecimal value <code>HH</code> (or<code>HHHH</code>, or <code>HHHHHHHH</code>)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Two relevant operations:</p>
<ul>
<li><em>escaping</em>: converting a <em>character string</em> into another character string with <em>escape sequences</em> for non-printable characters</li>
<li><em>unescaping</em>: the other way around</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="escape-sequences-in-python">Escape sequences in Python</h2>
<p>Function to <em>escape</em> strings:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">escape</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'unicode_escape'</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'ascii'</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Function to <em>unescape</em> strings:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">unescape</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'ascii'</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'unicode_escape'</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Usage example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">"""
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">value1 \ value2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">value3 / value4
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">"""</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">escape</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># \nvalue1 \\ value2\nvalue3 / value4\n</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">escape</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># False</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">unescape</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">escape</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#8f5902;font-style:italic"># True</span>
</span></span></code></pre></div></section><section>
<h2 id="data-representation-formats-json">Data representation formats: JSON</h2>
<ul>
<li>A <code>.json</code> file contains a <strong>document</strong>, i.e. a <em>characters</em> string
<ul>
<li>encoding: <em>UTF-8</em></li>
</ul>
</li>
<li>The file essentially a representation of a <em>tree-like</em> data structure…</li>
<li>… where each <em>element</em> is one of the following:
<ul>
<li><em>value</em> (e.g. <em>string</em>, <em>number</em>, <em>boolean</em>, <em>null</em>)</li>
<li><em>object</em> (i.e. dictionary) of <em>key-value</em> pairs, where <em>keys</em> are <em>strings</em>, and <em>values</em> are <em>values</em></li>
<li><em>array</em> (i.e. list) of <em>values</em></li>
</ul>
</li>
</ul>
<h3 id="example">Example:</h3>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col " style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"John Doe"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"age"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"is_student"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"is_teacher"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"stats"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">"height"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1.83</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">"weight"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">82.5</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"working_hours"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[{</span><span style="color:#204a87;font-weight:bold">"mon"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"tue"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"wed"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"thu"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"fri"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">}],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"address"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"street"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"123 Main St"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"city"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Springfield"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"state"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"IL"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"zip"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"62701"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></div>
<div class="col " style="text-align: left;"><p><img src="http://www.plantuml.com/plantuml/svg/JP51JyCm38Nl_HMHpzL4EzWcJZjm0S5fHuIcQ76RG9TKYQCAglntugxTbfFzFLllMTa7afw-WxF5M8ZymCepmhE0DwUjU748vONBbl5ZFRUz365mNcLcOzVDr8HZeAZGKkQDx0BU149vqkYpG3ukFDjJo6WKeD6qclUgrMvT2XYMVbUldaIQ5xBdZx7jKRleUV5pXBEpF9LACG95JhcTwW7LjIOThpEDDxdUfA_bCgKyXYd51EPW7f7TeQhNuaCQAmu4vMtWPEYNvKFlSvx6OAVkPJuCMNzzlyT_fcUugRSF5Kmu5QdOerNy1_y0" alt=""></p>
</div>
</div>
</div>
</section><section>
<h2 id="json-parsing--generation-in-python">JSON parsing / generation in Python</h2>
<ul>
<li>
<p>Python comes with the <em>built-in</em> <a href="https://docs.python.org/3/library/json.html">module <code>json</code></a> to <em>parse</em> and <em>generate</em> JSON documents</p>
<ul>
<li><code>json.loads(s)</code>: parses a <em>string</em> <code>s</code> representing a JSON document into a Python <em>object</em></li>
<li><code>json.dumps(o)</code>: generates a JSON document <em>string</em> from a Python <em>object</em> <code>o</code></li>
</ul>
</li>
<li>
<p>Object to JSON conversion table</p>
<ul>
<li>JSON <em>boolean</em> $\leftrightarrow$ Python <code>bool</code></li>
<li>JSON <em>number</em> $\leftrightarrow$ Python <code>int</code> or <code>float</code></li>
<li>JSON <em>string</em> $\leftrightarrow$ Python <code>str</code></li>
<li>JSON <em>array</em> $\leftrightarrow$ Python <code>list</code></li>
<li>JSON <em>object</em> $\leftrightarrow$ Python <code>dict</code></li>
<li>JSON <em>null</em> $\leftrightarrow$ Python <code>None</code></li>
</ul>
</li>
<li>
<p>Example of JSON parsing:</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000">doc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">'{"name": "John Doe", "age": 42, "password": null, "is_student": false, "is_teacher": true, "stats": {"height": 1.83, "weight": 82.5}, "working_hours": [{"mon": 8}, {"tue": 7}, {"wed": 7}, {"thu": 8}, {"fri": 6}], "address": {"street": "123 Main St", "city": "Springfield", "state": "IL", "zip": "62701"}}'</span>
</span></span><span style="display:flex;"><span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">object</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">loads</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">doc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'dict'&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'name'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'name'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'str'&gt; John Doe</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'age'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'age'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'int'&gt; 42</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'password'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'password'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'NoneType'&gt; None</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'is_student'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'is_student'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'bool'&gt; False</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'is_teacher'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'is_teacher'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'bool'&gt; True</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'stats'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'stats'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'dict'&gt; {'height': 1.83, 'weight': 82.5}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'working_hours'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'working_hours'</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># &lt;class 'list'&gt; [{'mon': 8}, {'tue': 7}, {'wed': 7}, {'thu': 8}, {'fri': 6}]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">doc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># True</span>
</span></span></code></pre></div>
</section>
</section><section>


<section data-shortcode-section="">
<h1 id="running-example-authentication">Running Example: Authentication</h1>
<p>(Part 1)</p>
</section><section>
<h2 id="how-to-support-authentication">How to support authentication</h2>
<h3 id="assuming-a-user-database-exists">Assuming a User Database exists…</h3>
<ol>
<li>
<p>letting users <strong>create</strong> a <em>new account</em></p>
<ul>
<li>relevant data: <em>username</em>, <em>email addresses</em>, <em>full name</em>, <em>role</em>, <em>password</em>
<ul>
<li>only <em>hashed</em> password are stored in-memory, <a href="https://stytch.com/blog/what-is-password-hashing/">for security reasons</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>letting users <strong>get</strong> information about registered accounts (public information only) by <em>id</em> (i.e., either username or some email)</p>
</li>
<li>
<p>letting users <strong>test</strong> whether their <em>password</em> is correct or not</p>
</li>
</ol>
<h3 id="-an-authentication-service-can-be-implemented">… an Authentication Service can be implemented</h3>
<ol>
<li>letting users <strong>generate</strong> an <em>authentication token</em> by providing their <em>credentials</em>
<ul>
<li><strong>credentials</strong>: <em>user id</em> (username or email address) + <em>password</em></li>
<li><strong>token</strong>: a <em>document</em> generated by the server, that the client can use to <em>prove</em> its identity in <em>future</em> interactions
<ul>
<li>composed by: <em>user data</em>, <em>expiration date</em>, <em>signature</em></li>
<li>easy for the server to <em>verify</em> the signature, but <em>hard</em> for the client to <em>forge</em></li>
<li>signature $\approx$ <a href="https://en.wikipedia.org/wiki/HMAC">Hash-based Message Authentication Code (HMAC)</a></li>
</ul>
</li>
</ul>
</li>
<li>letting users <strong>test</strong> whether an <em>authentication token</em> is <em>valid</em> or not
<ul>
<li><strong>valid</strong>: the token is <em>not expired</em>, and the <em>signature</em> is <em>correct</em></li>
</ul>
</li>
</ol>
</section><section>
<h2 id="modelling-classes">Modelling (classes)</h2>
<figure id="plantuml-figure-1729933614681631496" class="plantuml" alt="" style="width: 100%;height: 60vh;max-width: 95vw;max-height: 80vh;">
<p>package “users” {
class User {
+username: str
+emails: set[str]
+full_name: str
+role: Role
+password: str
+ids: set[str]
}</p>
<pre><code>class Credentials {
    +id: str
    +password: str
}

class Token {
    +user: User
    +expiration: datetime
    +signature: str
}

enum Role {
    ADMIN
    USER
}

interface UserDatabase {
    +add_user(user: User)
    +get_user(id: str) : User
    +check_password(credentials) : bool
}

interface AuthenticationService {
    +authenticate(credentials, duration) : Token
    +validate_token(token) : bool
}

package "impl" {
    class InMemoryUserDatabase {
        +__users: dict[str, User]
        +add_user(user: User)
        +get_user(id: str) : User
        +check_password(credentials) : bool
        +__get_user(id: str) : User
    }

    class InMemoryAuthenticationService {
        +__database: UserDatabase
        +__secret: str
        +authenticate(credentials, duration) : Token
        +validate_token(token) : bool
        +__validate_token_signature(token) : bool
    }

    InMemoryAuthenticationService *-l- InMemoryUserDatabase
}

UserDatabase &lt;|.. InMemoryUserDatabase
AuthenticationService &lt;|.. InMemoryAuthenticationService
</code></pre>
<p>}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1729933614681631496");
</script>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col " style="text-align: left;"><ul>
<li>Data classes in <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/users/__init__.py"><code>snippets.lab4.users</code></a>:
<ul>
<li><code>User</code>: represents an account</li>
<li><code>Credentials</code>: an id—password pair</li>
<li><code>Token</code>: represents an authentication token</li>
<li><code>Role</code>: enumeration with admissible roles</li>
</ul>
</li>
</ul>
</div>
<div class="col " style="text-align: left;"><ul>
<li>Interfaces in <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/users/__init__.py"><code>snippets.lab4.users</code></a>:
<ul>
<li><code>UserDatabase</code>: interface for a user database</li>
<li><code>AuthenticationService</code>: interface for an authentication service</li>
</ul>
</li>
<li>Implementation classes in <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/users/impl.py"><code>snippets.lab4.users.impl</code></a>:
<ul>
<li><code>InMemoryUserDatabase</code>: default implementation of user DB</li>
<li><code>InMemoryAuthenticationService</code>: default implementation of authentication service</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</section><section>
<h2 id="modelling-interaction">Modelling (interaction)</h2>
<p><img src="https://www.plantuml.com/plantuml/svg/jLNRQXin47tNLynJyMBN7s3OaE8QMkW5ahHzQCeoMKrjaLt9wEAcVr-j54-sD5uKaZxPp4XdvfmvEpft7gqFVITsIXByDCRVc3iXiFN6mXT7LWY97c_G4RpN7watzlSGVdiV5FjuNxLgZzhpWJV1xqZ7C7fbz2NPWsf9YBg6jQKOqzi43NKjHFhp-knHy1MWb4s8aLceXfxK0Vs9FXuBdiPj4ghx7fR3hyQUVa0D0QxrjHybgKVLvSp90aaaIPFT9UuNXF89rBVaCtKbNvPxIFMFB9UnJYennMy5bdom6a8fsVMEsjl8TfYu7Bo0dIiWtGxNcZqwzyjOEMij_NVogSYI5IX6KguvOATaH7it6z2MnxQh2keOJC0SB1EOKOj4_c2sIiFiojoIll-qZ1wA2zPv-fjS0Jw4AJRCirg033RZiVxJM68oMppoKG_FcFm4vQShZPtdqvCi2whpSacEKJ8jb_WtRnwwswkiUWn_-lmDvZo6VC2fhSROFh7hO3w-DOVBpVfYSrLDzlclxPA54jvY1BTug5S9wXo1DkLIS0bKyUPNx09jh3LMa1wBNl1g_9LXmqT49TdonOu_v6lK-CJPluo_2mgF5ePFpmw_FQ3qqHTvpA_YYT5Kpv8NECD3oMicWy4yPfxl1EwoV4Bdf6Nekpy0" alt=""></p>
<p>(open in another tab to zoom in)</p>
</section><section>
<h2 id="exemplify-implementation">Exemplify implementation</h2>
<p>(cf. <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example0_users.py">https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example0_users.py</a>)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">.users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">.users.impl</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">user_db</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">InMemoryUserDatabase</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">auth_service</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">InMemoryAuthenticationService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user_db</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ADMIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_user_hidden_password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gc_user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_credentials_ok</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">Credentials</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gc_user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">password</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">id</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">gc_user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ids</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#8f5902;font-style:italic"># type: ignore</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_credentials_wrong</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Credentials</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'wrong password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Trying to get a user that does not exist should raise a KeyError</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">KeyError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#4e9a06">'User with ID gciatto not found'</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Adding a novel user should work</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Trying to add a user that already exist should raise a ValueError</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">startswith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'User with ID'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">endswith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'already exists'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Getting a user that exists should work</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">gc_user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Checking credentials should work if there exists a user with the same ID and password (no matter which ID is used)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">gc_cred</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">gc_credentials_ok</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">check_password</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_cred</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Checking credentials should fail if the password is wrong</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">check_password</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_credentials_wrong</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Authenticating with wrong credentials should raise a ValueError</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auth_service</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">authenticate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_credentials_wrong</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#4e9a06">'Invalid credentials'</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Authenticating with correct credentials should work</span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auth_service</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">authenticate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_credentials_ok</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The token should contain the user, but not the password</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">gc_token</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">gc_user_hidden_password</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The token should expire in the future</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">gc_token</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">expiration</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">datetime</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A genuine, unexpired token should be valid</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">auth_service</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">validate_token</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_token</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A token with wrong signature should be invalid</span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_token_wrong_signature</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gc_token</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signature</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'wrong signature'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">auth_service</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">validate_token</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_token_wrong_signature</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A token with expiration in the past should be invalid</span>
</span></span><span style="display:flex;"><span><span style="color:#000">gc_token_expired</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auth_service</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">authenticate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_credentials_ok</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">timedelta</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">milliseconds</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">auth_service</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">validate_token</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_token_expired</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span></code></pre></div><ul>
<li>run with <code>python -m snippets -l 4 -e 0</code>
<ul>
<li>analyse the logs to understand what’s going on</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="whats-next">What’s next?</h2>
<p>In the remainder of this lecture, we will focus on making the <em>user database</em> and <em>authentication service</em> <strong>distributed</strong>:</p>
<ol>
<li>clients will be able to <em>register</em> and <em>authenticate</em> themselves <em>remotely</em>, via <strong>RPC</strong></li>
<li>we will use <strong>JSON</strong> as the <em>data interchange format</em> for <em>RPC</em> and <em>(de)serialization</em></li>
<li>notice that many different sorts of <em>data</em> may be exchanged between <em>clients</em> and <em>servers</em>
<ul>
<li>e.g. <em>user data</em>, <em>credentials</em>, <em>authentication tokens</em>, etc.,</li>
<li>but also, indirectly: <em>strings</em>, <em>dates</em>, <em>roles</em>, etc.</li>
<li>potentially, also <em>error messages</em>?</li>
</ul>
</li>
<li>let’s proceed step by step</li>
</ol>

</section>
</section><section>


<section data-shortcode-section="">
<h2 id="deserialization">(De)Serialization</h2>
<ul>
<li><strong>Serialization</strong> $\equiv$ converting <em>in-memory</em> <strong>objects</strong> into <strong>char</strong>/<em>byte</em> <strong>sequences</strong>, according to some <em>data interchange format</em></li>
<li><strong>Deserialization</strong> $\equiv$ converting <strong>char</strong>/<em>byte</em> <strong>sequences</strong> back into <em>in-memory</em> <strong>objects</strong>, according to the <em>same</em> data interchange format</li>
</ul>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Role</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ADMIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
<div class="col col-2" style="text-align: left;"><p>$\xrightarrow{\text{serialization}}$</p>
<p>$\xleftarrow{\text{deserialization}}$</p>
</div>
<div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"username"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"gciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"emails"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">"giovanni.ciatto@unibo.it"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">"giovanni.ciatto@gmail.com"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"full_name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Giovanni Ciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"role"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"ADMIN"</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"my secret password"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></div>
</div>
</div>
<ul>
<li>
<p>One key part in any distributed system <em>design</em> / implementation is how to about <em>supporting</em> (de)serialization:</p>
<ul>
<li><em>what</em> data should be (de)serialized?</li>
<li>how exactly should it be (de)serialized?
<ul>
<li>which <em>data interchange format</em> should be used?</li>
<li>which <em>fields</em> should be serialized? which ones could be <em>omitted</em>?</li>
<li>how to deal with <em>circular references</em>?</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Engineers will commonly design/implement <strong>(de)serializers</strong>:</p>
<ul>
<li>i.e. <em>objects</em> aimed at <em>performing</em> (de)serialization…</li>
<li>… for <em>all</em> relevant <em>data types</em> in the system
<ul>
<li>and the other <em>data types</em> they depend on</li>
<li>there including relevant <em>built-in</em> types from the <em>programming language</em> used (e.g. <code>datetime</code>, <code>set</code>, etc.)</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="deserialization-in-practice">(De)Serialization in Practice</h2>
<ul>
<li>
<p><em>Serialisation</em> usually involves the construction of an <strong>Abstract Syntax Tree</strong> (AST) from the <em>in-memory</em> object</p>
<ul>
<li>the AST is then <em>converted</em> into a <em>char</em>/<em>byte</em> sequence</li>
</ul>
</li>
<li>
<p><em>Deserialisation</em> usually involves the <em>opposite</em> process:</p>
<ul>
<li>the <em>char</em>/<em>byte</em> sequence is then <em>converted back</em> into an AST</li>
<li>the AST is then <em>converted back</em> into an <em>in-memory</em> object</li>
</ul>
</li>
</ul>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-4" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Python object</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ADMIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
<div class="col col-4" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&nbsp;Python dict (AST)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'ADMIN'</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
<div class="col col-4" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// JSON document
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"username"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"gciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"emails"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">"giovanni.ciatto@unibo.it"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">"giovanni.ciatto@gmail.com"</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"full_name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Giovanni Ciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"role"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"ADMIN"</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"my secret password"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></div>
</div>
</div>
<ul>
<li>Many (de)serialization <em>libraries</em> exist for most common programming languages and data interchange formats
<ul>
<li>e.g. in Python: <a href="https://docs.python.org/3/library/json.html"><code>json</code></a>, <a href="https://docs.python.org/3/library/pickle.html"><code>pickle</code></a>, <a href="https://marshmallow.readthedocs.io/en/stable/"><code>marshmallow</code></a>, <a href="https://pypi.org/project/PyYAML/"><code>PyYaml</code></a>, etc.</li>
</ul>
</li>
<li>They commonly provide for free:
<ul>
<li>serialization of AST into <em>char</em>/<em>byte</em> sequences</li>
<li>deserialization of <em>char</em>/<em>byte</em> sequences into AST</li>
<li>sometimes, AST $\leftrightarrow$ built-in data type conversions</li>
</ul>
</li>
<li>Users <strong>must</strong> <em>define</em> AST $\leftrightarrow$ custom data type conversion for all <em>relevant</em> data types in their systems</li>
</ul>
</section><section>
<h2 id="serialization-in-python-attempt-1">Serialization in Python (attempt 1)</h2>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Role</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">to_serialize</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ADMIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
<div class="col col-2" style="text-align: left;"><p>$\xrightarrow{\text{serialization}}$</p>
</div>
<div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"username"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"gciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"emails"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">"giovanni.ciatto@unibo.it"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">"giovanni.ciatto@gmail.com"</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"full_name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Giovanni Ciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"role"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"ADMIN"</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"my secret password"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></div>
</div>
</div>
<p>Let’s implement a serializer:</p>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-8" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Serializer</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_ast_to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># objct -&gt; AST -&gt; JSON string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_ast_to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">indent</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># AST -&gt; JSON string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># here we select which conversion to apply based on the type of obj</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_user_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Role</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_role_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ValueError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">'unsupported type: </span><span style="color:#4e9a06">{</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_user_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># User -&gt; AST</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">'username'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">username</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">'emails'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">emails</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">'full_name'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">full_name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">'role'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_role_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">'password'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">password</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_role_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">role</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Role</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># Role -&gt; AST</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">'name'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></div>
<div class="col " style="text-align: left;"><figure id="plantuml-figure-1729933614706453957" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
<p>class Serializer {
+serialize(obj: object) : str
-_ast_to_string(data) : str
-_to_ast(obj: object) : object
-_user_to_ast(user: User) : dict
-_role_to_ast(role: Role) : dict
}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1729933614706453957");
</script>
</div>
</div>
</div>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000">serializer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Serializer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to_serialize</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># prints the JSON document</span>
</span></span></code></pre></div></section><section>
<h2 id="deserialization-in-python-attempt-1">Deserialization in Python (attempt 1)</h2>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000">to_deserialize</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">"""{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  "username": "gciatto",
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  "emails": [
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    "giovanni.ciatto@unibo.it",
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    "giovanni.ciatto@gmail.com"
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  "full_name": "Giovanni Ciatto",
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  "role": {"name": "ADMIN"},
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  "password": "my secret password",
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}"""</span>
</span></span></code></pre></div></div>
<div class="col col-2" style="text-align: left;"><p>$\xrightarrow{\text{deserialization}}$</p>
</div>
<div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Role</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ADMIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
</div>
</div>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-8" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Deserializer</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">string</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_ast_to_obj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_ast_to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># JSON string -&gt; AST -&gt; object</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_ast_to_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">loads</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># JSON string -&gt; AST</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># here we select which conversion to apply based which keys are present in the AST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_ast_to_obj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">data</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'username'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'emails'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'full_name'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'role'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'password'</span><span style="color:#000;font-weight:bold">]):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_user_from_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#4e9a06">'name'</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_role_from_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ValueError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">'unsupported data: </span><span style="color:#4e9a06">{</span><span style="color:#000">data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_user_from_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># AST -&gt; User</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'username'</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'emails'</span><span style="color:#000;font-weight:bold">]),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'full_name'</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_ast_to_obj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'role'</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#8f5902;font-style:italic"># recursive call!</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'password'</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_role_from_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">Role</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># AST -&gt; Role</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Role</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'name'</span><span style="color:#000;font-weight:bold">]]</span>
</span></span></code></pre></div></div>
<div class="col " style="text-align: left;"><figure id="plantuml-figure-1729933614711125338" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
<p>class Deserializer {
+deserialize(string) : object
-_ast_to_string(data) : object
-_ast_to_obj(data) : object
-_user_from_ast(data) : User
-_role_from_ast(data) : Role
}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1729933614711125338");
</script>
</div>
</div>
</div>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000">deserializer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Deserializer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deserializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to_deserialize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># prints True</span>
</span></span></code></pre></div></section><section>
<h2 id="analysis-of-the-current-approach">Analysis of the current approach</h2>
<ul>
<li>
<p><strong>Pros</strong>:</p>
<ul>
<li>one method per <em>data type</em> to (de)serialize</li>
<li><em>automatically</em> understands <em>how</em> to (de)serilize the provided object/string</li>
<li>raises error on attempt to (de)serialize an <em>unsupported</em> data type</li>
<li>raises error on attempt to (de)serialize <em>invalid</em> data (e.g. missing fields)</li>
<li><em>easy</em> to <em>extend</em> to support <em>new</em> data types
<ol>
<li>requires adding <em>one more</em> method to the <code>Serializer</code> and <code>Deserializer</code> for the <em>new</em> data type</li>
<li>requires <em>modifying</em> the <code>_to_ast</code> and <code>_ast_to_obj</code> methods to <em>select</em> the <em>new</em> method</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>Cons</strong>:</p>
<ul>
<li>quite <em>verbose</em> and <em>repetitive</em></li>
<li>the <em>type</em> of the <em>object</em> to <em>de</em>serialize is <strong>inferred</strong> from the <em>keys</em> present in the <em>AST</em>
<ul>
<li>this may lead to <em>ambiguities</em> if <em>different</em> data types <em>share</em> the <em>same</em> <em>keys</em>
<ul>
<li>e.g. what if <em>another</em> data type has a <code>name</code> key (other than <code>Role</code>)?</li>
</ul>
</li>
<li>this may lead to <em>errors</em> if <em>some</em> <em>keys</em> are <em>missing</em> in the <em>AST</em></li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="deserialization-in-python-attempt-2">(De)Serialization in Python (attempt 2)</h2>
<p><strong>Improvement</strong>: <em>explicitly</em> <em>tag</em> the <em>type</em> of the object to <em>serialize</em> in the <em>AST</em>, and use this tag to <em>select</em> the right method to <em><strong>de</strong>serialize</em></p>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Role</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">emails</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">'giovanni.ciatto@unibo.it'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">'giovanni.ciatto@gmail.com'</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">full_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'Giovanni Ciatto'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">Role</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ADMIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my secret password'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
<div class="col col-2" style="text-align: left;"><p>$\xrightarrow{\text{serialization}}$</p>
<p>$\xleftarrow{\text{deserialization}}$</p>
</div>
<div class="col col-5" style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"username"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"gciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"emails"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">"giovanni.ciatto@unibo.it"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">"giovanni.ciatto@gmail.com"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"full_name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Giovanni Ciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"role"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"ADMIN"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Role"</span> <span style="color:#8f5902;font-style:italic">// explicit type field
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"my secret password"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"User"</span> <span style="color:#8f5902;font-style:italic">// explicit type field
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></div>
</div>
</div>
<p>Apply these updates to the <code>Serializer</code> and <code>Deserializer</code> classes:</p>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col " style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Serializer</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># rest of the class unchanged</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_user_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Role</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_role_to_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ValueError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">'unsupported type: </span><span style="color:#4e9a06">{</span><span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'$type'</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__name__</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span>
</span></span></code></pre></div></div>
<div class="col " style="text-align: left;"><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Deserializer</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># rest of the class unchanged</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_ast_to_obj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'$type'</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__name__</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_user_from_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">'$type'</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Role</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__name__</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_role_from_ast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ValueError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">'unsupported data: </span><span style="color:#4e9a06">{</span><span style="color:#000">data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></div>
</div>
</div>
<ul>
<li>Let’s use <code>$type</code> as the type tag <em>key</em>:
<ul>
<li>the <em>dollar</em> is just a character that is <em>unlikely</em> to be used in <em>real</em> data to minimize the risk of <em>collisions</em>
<ul>
<li>(but any other unlikely character would work as well)</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="deserialization-in-python-full-example">De(Serialization) in Python (full example)</h2>
<ol>
<li>See the example at <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example1_presentation.py">https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example1_presentation.py</a></li>
</ol>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-10" style="text-align: left;"><ol start="2">
<li>
<p>Notice the two new classes: <code>Request</code> and <code>Response</code></p>
 <!-- - `Request`: represents an RPC request to the server
     + `name`: the name of the function to call
     + `args`: the arguments to pass to the function
 - `Response`: represents an RPC response from the server
     + `result`: the result of the function call
     + `error`: an error message in case of failure -->
</li>
<li>
<p>Notice how complex the <code>Serializer</code> and <code>Deserializer</code> classes may become in a real usecase</p>
</li>
<li>
<p>Try to figure out how the following object…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.example0_users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">gc_credentials_wrong</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">'my_function'</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gc_credentials_wrong</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic"># an instance of Credentials</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gc_user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic"># an instance of User</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">"a string"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3.14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#8f5902;font-style:italic"># a list, containing various primitive types</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">'key'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">'value'</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic"># a dictionary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Response</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'an error'</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic"># a Response, which contains a None field</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></li>
<li>
<p>… would be serialized as the following JSON</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"my_function"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">"args"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">"id"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"giovanni.ciatto@unibo.it"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"wrong password"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Credentials"</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">"user"</span><span style="color:#a40000">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"username"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"gciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"emails"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">"giovanni.ciatto@gmail.com"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">"giovanni.ciatto@unibo.it"</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"full_name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Giovanni Ciatto"</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"role"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">"name"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"ADMIN"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Role"</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"password"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"User"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">"a string"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3.14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">"key"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"value"</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">"result"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">"error"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"an error"</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Response"</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">"$type"</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">"Request"</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
</div>
<div class="col col-2" style="text-align: left;"><figure id="plantuml-figure-1729933614719819536" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
<p>class Request {
+ name: str
+ args: tuple
}</p>
<p>Request -d[hidden]- Response</p>
<p>class Response {
+ result: object
+ error: str
}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1729933614719819536");
</script>
<ol start="6">
<li>Run with <code>python -m snippets -l 4 -e 1</code></li>
</ol>
</div>
</div>
</div>

</section>
</section><section>


<section data-shortcode-section="">
<h2 id="remote-procedure-call-rpc">Remote Procedure Call (RPC)</h2>
<blockquote>
<p><strong>RPC</strong> $\equiv$ a <em>request—response</em> interaction pattern between a <em>client</em> and a <em>server</em> where:
the client aims at <em>invoking</em> a <em>procedure</em> on the server, and receiving the <em>result</em> of the procedure back
as if the procedure was <em>locally</em> executed, despite the <em>server</em> being <em>remote</em></p>
</blockquote>
<ul>
<li>
<p>(Remote) <strong>Procedure</strong> $\equiv$ a <em>function</em> with a clear <em>signature</em>, <em>offered</em> by a <em>server</em>, to be <em>invoked</em> by a <em>client</em></p>
<ul>
<li><em>name</em> (or <em>identifier</em>)</li>
<li><em>input</em> parameters</li>
<li><em>returns</em> value(s), there including <em>errors</em> that may or may not be <em>raised</em> during the <em>execution</em></li>
<li><em>side effects</em> (if any) which may change the <em>state</em> of the <em>server</em>, hence affecting the result of <em>future</em> calls</li>
</ul>
</li>
<li>
<p>Differences w.r.t. <em>local</em> procedure calls:</p>
<ol>
<li>caller and callee are <em>not</em> in the <em>same</em> <em>address space</em> $\Rightarrow$ can<em>not</em> pass arguments <em>by reference</em>
<ul>
<li>passage <em>by value</em> is the only option: <em>copies</em> of arguments must be transferred over the network</li>
</ul>
</li>
<li>input parameters and return values must be <em>serialized</em> and <em>deserialized</em> to pass through the <em>network</em></li>
<li><em>exceptions</em> do not really exist, ad-hoc <em>return values</em> are used instead</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="rpc-client-and-server">RPC Client and Server</h2>
<br>
<img src="./rpc-time.png" alt="" style="max-width: 95vw; max-height: 80vh; object-fit: contain;">
<ul>
<li>The <em>client</em> and the <em>server</em> are <strong>temporally coupled</strong>
<ul>
<li>the <em>client</em> must <strong>wait</strong> for the <em>server</em> to <em>respond</em></li>
<li>the <em>server</em> must <strong>wait</strong> for the <em>client</em> to <em>send</em> the <em>request</em></li>
<li>they must be <em>online</em> at the <strong>same time</strong></li>
<li>the <em>server</em> must be <em>online</em> <strong>before</strong> the <em>client</em></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="common-rpc-infrastructure">Common RPC Infrastructure</h2>
<img src="./rpc-dataflow1.png" alt="" style="height: 50vh; max-width: 95vw; max-height: 80vh; object-fit: contain;">
<ul>
<li><strong>protocol</strong>: the low level <em>transfer</em> protocol (e.g. <em>HTTP</em>, <em>TCP</em>, <em>UDP</em>, etc.) + <em>data representation format</em> (e.g. <em>JSON</em>, <em>XML</em>, <em>binary</em>, etc.)</li>
<li><strong>client stub</strong>: a <em>proxy</em> object that <strong>mimics</strong> the <em>server</em> <em>interface</em> on the <em>client</em> side</li>
<li><strong>client</strong>: the piece of code which is using the <em>client stub</em>
<ul>
<li>it may not even be aware of the fact that the <em>server</em> is <em>remote</em></li>
</ul>
</li>
<li><strong>server stub</strong>: a <em>server</em> which listens for requests, handles them (possibly concurrently) and sends back responses
<ul>
<li>it commonly acts as a <em>proxy</em> towards some actual <em>server</em> code</li>
</ul>
</li>
<li><strong>server</strong>: the piece of code which is <em>executing</em> the <em>actual procedure</em> on the <em>server</em> side
<ul>
<li>it may not even be aware of the fact that the <em>client</em> is <em>remote</em></li>
<li><em>beware</em>! In this case “server” means <em>“provider of a functionality”</em>: the infrastructural component is actually the “server stub”!</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="marshalling-and-unmarshalling">Marshalling and Unmarshalling</h2>
<p>The client and server <em>stubs</em> are essentially aimed at performing these operations:</p>
<img src="./rpc-dataflow2.svg" alt="" style="height: 50vh; max-width: 95vw; max-height: 80vh; object-fit: contain;">
<ul>
<li><strong>Marshalling</strong>: the process of <em>serializing</em> the arguments/results of a RPC to send them over the network</li>
<li><strong>Unmarshalling</strong>: the process of <em>deserializing</em> the arguments/results of a RPC received from the network</li>
</ul>
</section><section>
<h2 id="request-and-response-types-in-rpc">Request and Response Types in RPC</h2>
<p>To support RPC, implementation will most commonly define two data structures:</p>
<ul>
<li><code>Request</code>: a data structure representing the <em>invokation request</em> to be sent to the <em>server</em>
<ul>
<li>it will contain the <em>name</em> of the <em>procedure</em> to be <em>invoked</em>, and the <em>arguments</em> to be passed to it, etc.</li>
</ul>
</li>
<li><code>Response</code>: a data structure representing the <em>response</em> to be sent back to the <em>client</em>
<ul>
<li>it will contain the <em>result</em> of the <em>procedure</em> (if any), and the <em>error</em> message (if any), etc.</li>
</ul>
</li>
</ul>
<div class="container w-100 m-0 p-0">
    <div class="row "><div class="col col-3" style="text-align: left;"><figure id="plantuml-figure-1729933614723867927" class="plantuml" alt="" style="width: 100%;height: 60vh;max-width: 95vw;max-height: 80vh;">
<p>class Request {
+ name: str
+ args: tuple
}</p>
<p>Request -d[hidden]- Response</p>
<p>class Response {
+ result: object
+ error: str
}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1729933614723867927");
</script>
</div>
<div class="col " style="text-align: left;"><figure id="plantuml-figure-1729933614724024450" class="plantuml" alt="" style="width: 100%;height: 60vh;max-width: 95vw;max-height: 80vh;">
<p>@startuml
hide footbox</p>
<p>actor Client
participant “Client Stub” as CS
control “Server Stub” as SS
participant Server</p>
<p>Client -&gt; CS: f(a, b, c)
activate Client
activate CS
CS -&gt; CS: req = Request(name=‘f’, args=(a, b, c)) \n req = serialize(req)
CS -&gt; SS: {“name”=“function”, “args”=[a, b, c]}
activate SS
SS -&gt; SS : req = deserialize(req)
SS -&gt; SS : lookup function req.name
SS -&gt; Server: f(a, b, c)
activate Server</p>
<p>alt success
Server –&gt; SS: return R
else exception
Server –&gt; SS: raise E
deactivate Server
end
SS -&gt; SS: res = Response(result=R, error=E) \n res = serialize(res)
SS -&gt; CS: {“result”: R, “error”: E}
deactivate SS
CS -&gt; CS: res = deserialize(res)</p>
<p>alt res.error is None
CS –&gt; Client: return res.result
else
CS –&gt; Client: raise res.error
deactivate CS
end
@enduml</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1729933614724024450");
</script>
</div>
</div>
</div>

</section>
</section><section>


<section data-shortcode-section="">
<h1 id="running-example-authentication">Running Example: Authentication</h1>
<p>(Part 2)</p>
</section><section>
<h2 id="server-stubs-for-the-user-database">Server Stubs for the User Database</h2>
<ul>
<li>The “actual” server (provider of functionality) here is some instance of the <code>InMemoryUserDatabase</code> class</li>
<li>We will exemplify how to build a <em>server stub</em> for that server
<ul>
<li>it will leverage on <em>TCP sockets</em> to listen for incoming requests, hence reusing <a href="../communication/#/utilities">the <code>Server</code> interface from the previous lecture</a></li>
</ul>
</li>
</ul>
<h3 id="design-considerations">Design considerations</h3>
<ol>
<li>assume each TCP connection is devoted to a <em>single</em> RPC, i.e. just one <em>request</em> and one <em>response</em></li>
<li>serve RPCs <em>concurrently</em>, by starting a new <em>thread</em> for each incoming connection</li>
<li>use the <code>Serializer</code> and <code>Deserializer</code> classes to (de)serialize <em>requests</em> and <em>responses</em></li>
<li>the server stub holds a reference to the <em>actual</em> server, and <em>delegates</em> the <em>actual</em> work to it
<ul>
<li>upon receiving a <em>request</em>, it <em>deserializes</em> it, <em>invokes</em> the <em>actual</em> server, <em>serializes</em> the <em>response</em>, and <em>sends</em> it back to the <em>client</em></li>
<li>if any <em>error</em> occurs, it <em>serializes</em> the <em>error</em> message and <em>sends</em> it back to the <em>client</em></li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab3</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Server</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.users.impl</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">InMemoryUserDatabase</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.example1_presentation</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Response</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">traceback</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ServerStub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__on_connection_event</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># start listening on port upon creation, call callback upon incoming connections</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__user_db</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">InMemoryUserDatabase</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic"># hold a reference to the actual server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__on_connection_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#8f5902;font-style:italic"># whenever a connection event occurs...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">match</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'listen'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if it's the server starting to listen:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'Server listening on </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># then log the address it's listening on</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'connect'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if it's a new connection:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">callback</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__on_message_event</span> <span style="color:#8f5902;font-style:italic"># then set the callback for incoming messages (this will start a thread under the hood)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'error'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if an error occurs while handling the connection:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">traceback</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">print_exception</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># then log it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'stop'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if the server stops listening:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'Server stopped'</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># log this information before quitting</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__on_message_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">payload</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#8f5902;font-style:italic"># whenever a message event occurs...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">match</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'message'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if it's a new message:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'[</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">] Open connection'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># log the connection</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">payload</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># deserialize the ingoing message</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># make sure it's a Request object (raise an error if not)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'[</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">] Unmarshall request:'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># log the request</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__handle_request</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># handle the request, compute the response</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># serialize the response and send it back</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'[</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">] Marshall response:'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># log the response</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic"># close the connection (this RPC is over!)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'error'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if an error occurs while handling the message:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">traceback</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">print_exception</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># log it</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">'close'</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># ... if the connection closes:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'[</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">] Close connection'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">connection</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># log this information</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__handle_request</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#8f5902;font-style:italic"># this is where the actual function to execute is selecte and executed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">getattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__user_db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># get the method from the user database</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># call the method with the arguments, store the result</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">None</span> <span style="color:#8f5902;font-style:italic"># no error occurred in this case</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">Exception</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># if an error occurs:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">None</span> <span style="color:#8f5902;font-style:italic"># no result in case of an error</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">" "</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># store the error message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Response</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># return a Response object with the result and the error message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">'__main__'</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">sys</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ServerStub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]))</span> <span style="color:#8f5902;font-style:italic"># server stub will listen on the port provided as argument</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">input</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'Close server with Ctrl+D (Unix) or Ctrl+Z (Win)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#c00;font-weight:bold">EOFError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#c00;font-weight:bold">KeyboardInterrupt</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>(see code in <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example2_rpc_server.py"><code>snippets.lab4.example2_rpc_server</code></a>, run with <code>python -m snippets -l 4 -e 2</code>)</p>
</section><section>
<h2 id="client-stubs-for-the-authentication-service">Client Stubs for the Authentication Service</h2>
<ul>
<li>We will exemplify how to build a <em>client stub</em> for the <em>user database</em>
<ul>
<li>it will leverage on <em>TCP sockets</em> to send requests to the server, hence reusing <a href="../communication/#/utilities">the <code>Client</code> interface from the previous lecture</a></li>
</ul>
</li>
<li>We create a general-purpose <em>abstract</em> class <code>ClientStub</code> to be <em>extended</em> by <em>specific</em> client stubs
<ul>
<li>for the user database, we create the <code>RemoteUserDatabase</code> class which inherits from <code>ClientStub</code> and implements the <code>UserDatabase</code> interface</li>
<li>this is to make the <em>RPC-based</em> implementation of the user database have the <strong>same interface</strong> of the in-memory implementation</li>
</ul>
</li>
</ul>
<h3 id="design-considerations-1">Design considerations</h3>
<ol>
<li>the <code>ClientStub</code> class comes with method <code>rpc(name, *args)</code> to issue an RPC to the server
<ul>
<li>the server address and port are passed to the <em>constructor</em>, as they are not supposed to change during the lifetime of the client stub</li>
</ul>
</li>
<li>the <code>RemoteUserDatabase</code> class implements the <code>UserDatabase</code> interface by <em>delegating</em> the <em>actual</em> work to the <code>rpc</code> method</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab3</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.example1_presentation</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Response</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ClientStub</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">server_address</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">tuple</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">]):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__server_address</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">server_address</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># memorize the server address</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rpc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__server_address</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># create a new TCP client instance</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'# Connected to </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># create a new request</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'# Marshalling'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'towards'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">"</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">"</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># serialize the request</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'# Sending message:'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06"># '</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># send the request</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">receive</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic"># receive the response</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'# Received message:'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06"># '</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># deserialize the response</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Response</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'# Unmarshalled'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">'from'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">"</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">"</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># if an error occurred:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">RuntimeError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># raise the error</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">result</span> <span style="color:#8f5902;font-style:italic"># otherwise, return the result</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">finally</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic"># in any case, before exiting:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic"># close the connection</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'# Disconnected from </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">'</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remote_address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RemoteUserDatabase</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ClientStub</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UserDatabase</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">server_address</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server_address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># notice how the following methods are implemented by RPC</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">add_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rpc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'add_user'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">get_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">id</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rpc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'get_user'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">id</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">check_password</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">credentials</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Credentials</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">bool</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rpc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'check_password'</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">credentials</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></section><section>
<h2 id="exemplify-programming-with-rpc-client-and-server">Exemplify Programming with RPC Client and Server</h2>
<ol>
<li>
<p>Start the server with <code>python -m snippets -l 4 -e 2 PORT</code></p>
<ul>
<li>where <code>PORT</code> is the port number the server will listen to, e.g. <code>8080</code></li>
<li>recall to <em>restart</em> the server too if you want to <em>restart</em> the client</li>
</ul>
</li>
<li>
<p>Run the following Python script (cf. <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example3_rpc_client.py"><code>snippets.lab4.example3_rpc_client</code> module</a>)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">snippets.lab4.example0_users</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">gc_user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gc_credentials_ok</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gc_credentials_wrong</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">sys</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">user_db</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RemoteUserDatabase</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Trying to get a user that does not exist should raise a KeyError</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">RuntimeError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#4e9a06">'User with ID gciatto not found'</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Adding a novel user should work</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Trying to add a user that already exist should raise a ValueError</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_user</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">RuntimeError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">startswith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'User with ID'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">endswith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'already exists'</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Getting a user that exists should work</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">'gciatto'</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">gc_user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Checking credentials should work if there exists a user with the same ID and password (no matter which ID is used)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">gc_cred</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">gc_credentials_ok</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">check_password</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_cred</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Checking credentials should fail if the password is wrong</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">user_db</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">check_password</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc_credentials_wrong</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span></code></pre></div><ul>
<li>launch it with <code>python -m snippets -l 4 -e 3 SERVER_IP:PORT</code>
<ul>
<li>where <code>SERVER_IP</code> (e.g. <code>localhost</code>) is the IP address of the server…</li>
<li>… and <code>PORT</code> is the port number the server is listening to (e.g. <code>8080</code>)</li>
</ul>
</li>
<li>this should succeed with no errors <em>the first time</em>
<ul>
<li>it will <em>fail</em> if you run it <em>one more time</em> without restarting the server! <strong>why</strong>?</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Look at the logs of the client and the server to understand what’s going on</p>
</li>
</ol>
</section><section>
<h2 id="exemplify-command-line-user-database-client">Exemplify Command-Line User Database Client</h2>
<ol>
<li>
<p>(Re)Start the server with <code>python -m snippets -l 4 -e 2 PORT</code></p>
<ul>
<li>where <code>PORT</code> is the port number the server will listen to, e.g. <code>8080</code></li>
<li>recall to <em>restart</em> the server too if you want to <em>restart</em> the client</li>
</ul>
</li>
<li>
<p>Play with the Python module <a href="https://github.com/unibo-fc-isi-ds/lab-snippets/blob/master/snippets/lab4/example4_rpc_client_cli.py"><code>snippets.lab4.example4_rpc_client_cli</code></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>usage: python -m snippets -l 4 -e 4 [-h] [--user USER] [--email EMAIL [EMAIL ...]] [--name NAME] [--role {admin,user}] [--password PASSWORD]
</span></span><span style="display:flex;"><span>                                    address {add,get,check}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RPC client for user database
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>positional arguments:
</span></span><span style="display:flex;"><span>address               Server address in the form ip:port
</span></span><span style="display:flex;"><span>{add,get,check}       Method to call
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>options:
</span></span><span style="display:flex;"><span>-h, --help            show this help message and exit
</span></span><span style="display:flex;"><span>--user USER, -u USER  Username
</span></span><span style="display:flex;"><span>--email EMAIL [EMAIL ...], --address EMAIL [EMAIL ...], -a EMAIL [EMAIL ...]
</span></span><span style="display:flex;"><span>                        Email address
</span></span><span style="display:flex;"><span>--name NAME, -n NAME  Full name
</span></span><span style="display:flex;"><span>--role {admin,user}, -r {admin,user}
</span></span><span style="display:flex;"><span>                        Role (defaults to "user")
</span></span><span style="display:flex;"><span>--password PASSWORD, -p PASSWORD
</span></span><span style="display:flex;"><span>                        Password
</span></span></code></pre></div></li>
<li>
<p>Consider the following sequence of commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>python -m snippets -l <span style="color:#0000cf;font-weight:bold">4</span> -e <span style="color:#0000cf;font-weight:bold">4</span> SERVER_IP:PORT get -u gciatto
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># [RuntimeError] User with ID gciatto not found</span>
</span></span><span style="display:flex;"><span>python -m snippets -l <span style="color:#0000cf;font-weight:bold">4</span> -e <span style="color:#0000cf;font-weight:bold">4</span> SERVER_IP:PORT add -u gciatto -a giovanni.ciatto@unibo.it giovanni.ciatto@gmail.com -n <span style="color:#4e9a06">"Giovanni Ciatto"</span> -r admin -p <span style="color:#4e9a06">"my secret password"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># None</span>
</span></span><span style="display:flex;"><span>python -m snippets -l <span style="color:#0000cf;font-weight:bold">4</span> -e <span style="color:#0000cf;font-weight:bold">4</span> SERVER_IP:PORT get -u gciatto
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># User(username='gciatto', emails={'giovanni.ciatto@unibo.it', 'giovanni.ciatto@gmail.com'}, full_name='Giovanni Ciatto', role=&lt;Role.ADMIN: 1&gt;, password=None)</span>
</span></span><span style="display:flex;"><span>python -m snippets -l <span style="color:#0000cf;font-weight:bold">4</span> -e <span style="color:#0000cf;font-weight:bold">4</span> SERVER_IP:PORT check -u gciatto -p <span style="color:#4e9a06">"my secret password"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># True</span>
</span></span><span style="display:flex;"><span>python -m snippets -l <span style="color:#0000cf;font-weight:bold">4</span> -e <span style="color:#0000cf;font-weight:bold">4</span> SERVER_IP:PORT check -u gciatto -p <span style="color:#4e9a06">"wrong password"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># False</span>
</span></span></code></pre></div></li>
</ol>

</section>
</section>

<section data-noprocess="" data-shortcode-slide="" id="exercise-rpc-auth-service">
  
<h2 id="exercise-rpc-based-authentication-service">Exercise: RPC-based Authentication Service</h2>
<ul>
<li>
<p><strong>Prerequisites</strong>:</p>
<ol>
<li>understand the <em>(de)serialization</em> we have just exemplified</li>
<li>understand the <em>RPC</em> infrastructure we have just exemplified</li>
</ol>
</li>
<li>
<p><strong>Goal</strong>: extend the exemplified <em>RPC</em> infrastructure to support an <em>authentication service</em></p>
<ul>
<li>the server stub should <em>delegate</em> the <em>actual</em> work to an <em>actual</em> <code>InMemoryAuthenticationService</code> instance</li>
<li>one more client stub should be created to for the <code>AuthenticationService</code> interface</li>
<li>the command-line interface of the client should be extended accordingly</li>
</ul>
</li>
<li>
<p><strong>Hints</strong>: you must reuse the provided code, modifying it: no need to create further Python files</p>
</li>
<li>
<p><strong>Deadline</strong>: two weeks from today</p>
</li>
<li>
<p><strong>Incentive</strong>: +1 point on the final grade (if solution is satisfying)</p>
</li>
<li>
<p><strong>Submission</strong>:</p>
<ol>
<li>fork the <a href="https://github.com/unibo-fc-isi-ds/lab-snippets"><code>lab-snippets</code> repository</a></li>
<li>create a new branch named <code>exercise-lab4</code></li>
<li>commit your solution in the <code>snippets/lab4</code> directory</li>
<li>push the branch to your fork &amp; create a <strong>pull request</strong> to the original repository, entitled <code>[A.Y. 2024/2025 Surname, Name] Exercise: RPC Auth Service</code>
<ul>
<li>in the pull request, describe your solution, motivate your choices, and explain how to test it</li>
</ul>
</li>
</ol>
</li>
</ul>
</section>

<section data-noprocess="" data-shortcode-slide="" id="exercise-rpc-auth-service-secure">
  
<h2 id="exercise-secure-rpc-based-authentication-service">Exercise: Secure RPC-based Authentication Service</h2>
<ul>
<li>
<p><strong>Prerequisites</strong>: complete previous exercise</p>
</li>
<li>
<p><strong>Goal</strong>: extend the exemplified <em>RPC</em> infrastructure to support <strong>authorization</strong></p>
<ul>
<li><em>reading</em> registered user data should <em>only</em> be possible for <em>authenticated</em> users whose <em>role</em> is <strong>admin</strong></li>
<li>any attempt do so by <em>unauthorized</em> or <em>unauthenticated</em> users should result in an <em>error</em> being returned</li>
<li>the command-line interface of the client should be extended accordingly</li>
</ul>
</li>
<li>
<p><strong>Hints</strong>:</p>
<ul>
<li>the <code>Request</code> class should be extended to include an optional <em>metadata</em> field
<ul>
<li>when the <em>client</em> performs an operation which <strong>requires</strong> <em>authentication</em>…</li>
<li>… the <em>metadata</em> field should be <em>filled</em> with the <em>token</em> of the <em>user</em></li>
</ul>
</li>
<li>the <code>ServerStub</code> should be extended to check for the presence and validity of the <em>token</em> in the <em>metadata</em> field</li>
<li>the client should be extended to memorize the <em>token</em> upon successful <em>authentication</em> and <em>pass</em> it in the <em>metadata</em> field of any <em>subsequent</em> request</li>
</ul>
</li>
<li>
<p><strong>Deadline</strong>: two weeks from today</p>
</li>
<li>
<p><strong>Incentive</strong>: +1 point on the final grade (if solution is satisfying)</p>
</li>
<li>
<p><strong>Submission</strong>:</p>
<ol>
<li>fork the <a href="https://github.com/unibo-fc-isi-ds/lab-snippets"><code>lab-snippets</code> repository</a></li>
<li>create a new branch named <code>exercise-lab4</code></li>
<li>commit your solution in the <code>snippets/lab4</code> directory</li>
<li>push the branch to your fork &amp; create a <strong>pull request</strong> to the original repository, entitled <code>[A.Y. 2024/2025 Surname, Name] Exercise: RPC Auth Service 2</code>
<ul>
<li>or just reuse the pull request and branch of the previous exercise, if you already submitted it</li>
<li>in the pull request, describe your solution, motivate your choices, and explain how to test it</li>
</ul>
</li>
</ol>
</li>
</ul>
</section><section>
<h1 id="lecture-is-over">Lecture is Over</h1>
<br>
<p>Compiled on: 2024-10-26
 — <a href="?print-pdf&amp;pdfSeparateFragments=false"><i class="fa fa-print" aria-hidden="true"></i> printable version</a></p>
<p><a href="../#/toc"><i class="fa fa-undo" aria-hidden="true"></i> back to ToC</a></p>
</section>

  


</div>
      

    </div>
<script type="text/javascript" src="/slides-module2.github.io/reveal-hugo/object-assign.js"></script>

<a href="/slides-module2.github.io/reveal-js/dist/print/" id="print-location" style="display: none;"></a>

<script type="application/json" id="reveal-hugo-site-params">{"custom_theme":"custom-theme.scss","custom_theme_compile":true,"custom_theme_options":{"enablesourcemap":true,"targetpath":"css/custom-theme.css"},"height":"1080","highlight_theme":"solarized-dark","history":true,"mermaid":[{}],"slide_number":true,"theme":"league","transition":"slide","transition_speed":"fast","width":"1920"}</script>
<script type="application/json" id="reveal-hugo-page-params">null</script>

<script src="/slides-module2.github.io/reveal-js/dist/reveal.js"></script>


  
  
  <script type="text/javascript" src="/slides-module2.github.io/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/slides-module2.github.io/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/slides-module2.github.io/reveal-js/plugin/zoom/zoom.js"></script>
  
  <script type="text/javascript" src="/slides-module2.github.io/reveal-js/plugin/notes/notes.js"></script>
  
  
  <script type="text/javascript" src="/slides-module2.github.io/reveal-js/plugin/notes/notes.js"></script>




<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };

  var revealHugoPlugins = { 
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom ]
   };
  var revealHugoSiteParams = JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);
  var revealHugoPageParams = JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);
  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins));
  Reveal.initialize(options);
</script>







  
  

  
  

  
  

  
  

  
  

  
  

  
  





    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
</script>

<script type="text/javascript" id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<script>
  if (/.*?(\?|&)print-pdf/.test(window.location.toString())) {
      var ytVideos = document.getElementsByTagName("iframe")
      for (let i = 0; i < ytVideos.length; i++) {
          var videoFrame = ytVideos[i]
          var isYouTube = /^https?:\/\/(www.)youtube\.com\/.*/.test(videoFrame.src)
          if (isYouTube) {
              console.log(`Removing ${videoFrame.src}`)
              var parent = videoFrame.parentElement
              videoFrame.remove()
              var p = document.createElement('p')
              p.append(
                  document.createTextNode(
                      "There was an embedded video here, but it is disabled in the printed version of the slides."
                  )
              )
              p.append(document.createElement('br'))
              p.append(
                  document.createTextNode(
                      `Visit instead ${
                          videoFrame.src
                      } or ${
                          videoFrame.src.replace(
                              /(^https?:\/\/(www.)youtube\.com)\/(embed\/)(\w+).*/,
                              "https://www.youtube.com/watch?v=$4"
                          )
                      }`
                  )
              )
              parent.appendChild(p)
          }
      }
  }
</script>


    
  

</body></html>